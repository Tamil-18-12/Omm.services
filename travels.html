<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travels & Adventures | OM Service</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">

    <!-- Clerk Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js" type="text/javascript"
        data-clerk-publishable-key="pk_test_ZXZvbHZlZC1ib2EtMS5jbGVyay5hY2NvdW50cy5kZXYk" crossorigin="anonymous">
        </script>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="logo-removebg-preview.png" alt="OM Service Logo">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="travels.html">Travels</a></li>
                    <li class="nav-item"><a class="nav-link" href="about.html">About Us</a></li>
                    <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                </ul>
                <div class="navbar-nav ms-auto">
                    <div id="user-button"></div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-5 pt-5 mb-5">
        <h1 class="hero-title text-center mb-5 mt-4">Discover Your Adventure</h1>

        <!-- Slideshow -->
        <div class="slideshow-container mx-auto" style="max-width: 900px;">
            <div class="slide active"
                style="background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1773&auto-format&fit=crop');">
            </div>
            <div class="slide"
                style="background-image: url('https://images.unsplash.com/photo-1454496522488-7a8e488e8606?q=80&w=1770&auto-format&fit=crop');">
            </div>
            <div class="slide"
                style="background-image: url('https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?q=80&w=1888&auto-format&fit=crop');">
            </div>
            <div class="slide"
                style="background-image: url('https://images.unsplash.com/photo-1469474868028-56623f02e42e?q=80&w=1774&auto-format&fit=crop');">
            </div>
            <div class="slide"
                style="background-image: url('https://images.unsplash.com/photo-1502602898657-3e91760c0341?q=80&w=1770&auto-format&fit=crop');">
            </div>

            <div class="slide-controls">
                <button class="slide-btn" onclick="changeSlide(-1)"><i class="bi bi-chevron-left"></i></button>
                <button class="slide-btn" onclick="changeSlide(1)"><i class="bi bi-chevron-right"></i></button>
            </div>
        </div>

        <!-- Packages -->
        <div class="row g-5 justify-content-center mt-4">

            <div class="col-lg-10">
                <div class="glass-panel p-0 d-flex flex-column flex-md-row overflow-hidden hover-lift"
                    onclick="openBookingModal('Mountain Adventure')">
                    <div class="col-md-5" style="min-height: 250px;">
                        <img src="https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1770&auto-format&fit=crop"
                            alt="Mountains" class="w-100 h-100" style="object-fit: cover;">
                    </div>
                    <div class="col-md-7 p-4 p-md-5 d-flex flex-column justify-content-center">
                        <span class="badge bg-gold text-dark mb-2 align-self-start">Adventure</span>
                        <h2 class="text-gold fw-bold mb-3">Majestic Mountains</h2>
                        <p class="text-white-50 mb-4">Explore breathtaking peaks, serene valleys, and stunning alpine
                            lakes. Perfect for adventurers.</p>
                        <button class="btn-secondary-glow align-self-start"
                            onclick="event.stopPropagation(); openBookingModal('Mountain Adventure')">
                            Book Now
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-lg-10">
                <div class="glass-panel p-0 d-flex flex-column flex-md-row overflow-hidden hover-lift"
                    onclick="openBookingModal('Beach Getaway')">
                    <div class="col-md-5" style="min-height: 250px;">
                        <img src="https://images.unsplash.com/photo-1509233725247-49e657c54213?q=80&w=1649&auto-format&fit=crop"
                            alt="Beach" class="w-100 h-100" style="object-fit: cover;">
                    </div>
                    <div class="col-md-7 p-4 p-md-5 d-flex flex-column justify-content-center">
                        <span class="badge bg-gold text-dark mb-2 align-self-start">Relaxation</span>
                        <h2 class="text-gold fw-bold mb-3">Sunny Beaches</h2>
                        <p class="text-white-50 mb-4">Relax on white sandy beaches, swim in crystal-clear waters, and
                            enjoy the perfect tropical getaway.</p>
                        <button class="btn-secondary-glow align-self-start"
                            onclick="event.stopPropagation(); openBookingModal('Beach Getaway')">
                            Book Now
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-lg-10">
                <div class="glass-panel p-0 d-flex flex-column flex-md-row overflow-hidden hover-lift"
                    onclick="openBookingModal('City Escape')">
                    <div class="col-md-5" style="min-height: 250px;">
                        <img src="https://images.unsplash.com/photo-1449824913935-59a10b8d2000?q=80&w=1770&auto-format&fit=crop"
                            alt="City" class="w-100 h-100" style="object-fit: cover;">
                    </div>
                    <div class="col-md-7 p-4 p-md-5 d-flex flex-column justify-content-center">
                        <span class="badge bg-gold text-dark mb-2 align-self-start">Urban</span>
                        <h2 class="text-gold fw-bold mb-3">Urban Escapes</h2>
                        <p class="text-white-50 mb-4">Dive into the vibrant culture of the world's most exciting cities.
                            Discover history, art, and cuisine.</p>
                        <button class="btn-secondary-glow align-self-start"
                            onclick="event.stopPropagation(); openBookingModal('City Escape')">
                            Book Now
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <div class="text-center mt-5">
            <button class="btn-primary-glow btn-lg px-5" onclick="openBookingModal('Custom Trip')">
                Customize Your Trip
            </button>
        </div>
    </div>

    <!-- Premium Booking Modal -->
    <div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content premium-booking">
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title" id="bookingTitle"><i class="fas fa-bus"></i> Book Your Trip</h5>
                        <p class="mb-0 text-white-50 small ms-4">Fill in the details below to confirm your travel
                            reservation</p>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 p-md-5">

                    <!-- Context Banner (Dynamic) -->
                    <div class="context-banner">
                        <i class="fas fa-map-marker-alt me-2"></i> <span id="displayDestination">Select
                            Destination</span>
                    </div>

                    <form id="bookingForm" onsubmit="handleBooking(event)">

                        <!-- Personal Info -->
                        <div class="form-section-title">
                            <i class="fas fa-user-circle"></i> Personal Information
                        </div>
                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <label class="premium-label"><i class="fas fa-user"></i> Full Name</label>
                                <input type="text" class="form-control-premium" id="name" required
                                    placeholder="Enter your full name">
                            </div>
                            <div class="col-md-6">
                                <label class="premium-label"><i class="fas fa-calendar-alt"></i> Age</label>
                                <input type="text" class="form-control-premium" id="age"
                                    placeholder="Your age (Optional)">
                            </div>
                            <div class="col-md-6">
                                <label class="premium-label"><i class="fas fa-phone"></i> Phone Number</label>
                                <input type="tel" class="form-control-premium" id="phone" required
                                    placeholder="Enter phone number">
                            </div>
                            <div class="col-md-6">
                                <label class="premium-label"><i class="fas fa-envelope"></i> Email Address</label>
                                <input type="email" class="form-control-premium" id="email" required
                                    placeholder="your@email.com">
                            </div>
                            <div class="col-12">
                                <label class="premium-label"><i class="fas fa-map-pin"></i> Address</label>
                                <textarea class="form-control-premium" id="address" required rows="2"
                                    placeholder="Enter your complete address"></textarea>
                            </div>
                        </div>

                        <!-- Trip Details -->
                        <div class="form-section-title">
                            <i class="fas fa-route"></i> Trip Details
                        </div>
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="premium-label"><i class="fas fa-calendar-day"></i> Travel Date</label>
                                <input type="date" class="form-control-premium" id="date" required>
                            </div>
                            <div class="col-md-6">
                                <label class="premium-label"><i class="fas fa-users"></i> Guests</label>
                                <input type="number" class="form-control-premium" id="guests" required min="1"
                                    placeholder="Number of people">
                            </div>
                            <div class="col-md-6">
                                <label class="premium-label"><i class="fas fa-map-marker-alt"></i> From Location</label>
                                <input type="text" class="form-control-premium" id="fromLoc" placeholder="City/Area">
                            </div>
                            <div class="col-md-6">
                                <label class="premium-label"><i class="fas fa-map-marker"></i> To Destination</label>
                                <input type="text" class="form-control-premium" id="toLoc" required
                                    placeholder="Destination">
                            </div>
                            <div class="col-md-12">
                                <label class="premium-label"><i class="fas fa-bus-alt"></i> Vehicle Preference</label>
                                <select class="form-control-premium form-select" id="vehicle">
                                    <option value="Luxury Bus">Luxury Bus (AC)</option>
                                    <option value="Mini Bus">Mini Bus</option>
                                    <option value="Tempo Traveller">Tempo Traveller</option>
                                    <option value="Car">Sedan / SUV</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn-premium-action">
                            Confirm Booking
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass-panel border-gold text-center p-4">
                <div class="mb-3">
                    <i class="bi bi-check-circle-fill text-gold" style="font-size: 4rem;"></i>
                </div>
                <h3 class="text-white fw-bold mb-2">Request Sent!</h3>
                <p class="text-white-50">We will contact you with the best packages.</p>
                <button type="button" class="btn-secondary-glow mt-3" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- Dynamic Content Loading ---
        async function loadDynamicContent() {
            try {
                const res = await fetch('/api/services?category=travel');
                const data = await res.json();

                if (data && data.length > 0) {
                    const service = data[0];

                    // 1. Update Slideshow
                    if (service.images && service.images.length > 0) {
                        const container = document.querySelector('.slideshow-container');
                        const controls = container.querySelector('.slide-controls');

                        // Remove old slides
                        container.querySelectorAll('.slide').forEach(el => el.remove());

                        // Add new slides
                        service.images.forEach((imgUrl, index) => {
                            const slide = document.createElement('div');
                            slide.className = `slide ${index === 0 ? 'active' : ''}`;
                            slide.style.backgroundImage = `url('${imgUrl}')`;
                            container.insertBefore(slide, controls);
                        });

                        // Re-init slideshow
                        initSlideshow();
                    }

                    // 2. Show Discount Toast/Banner if exists
                    if (service.discount) {
                        const discountToast = document.createElement('div');
                        discountToast.className = 'glass-panel p-3 text-center mb-4 border-gold animation-pulse';
                        discountToast.style.border = '2px dashed #fcdc3b';
                        discountToast.style.background = 'rgba(252, 220, 59, 0.1)';
                        discountToast.innerHTML = `
                            <h4 class="text-gold m-0 fw-bold"><i class="fas fa-tags me-2"></i> ${service.discount}</h4>
                            ${service.description ? `<p class="text-white-50 m-0 small mt-1">${service.description}</p>` : ''}
                        `;
                        // Insert after hero title
                        const title = document.querySelector('.hero-title');
                        title.parentNode.insertBefore(discountToast, title.nextSibling);
                    }
                } else {
                    initSlideshow();
                }
            } catch (e) {
                console.error('Failed to load dynamic content', e);
                initSlideshow();
            }
        }

        // Slideshow
        let slideIndex = 0;
        let slideTimer;

        function initSlideshow() {
            const slides = document.querySelectorAll('.slide');
            if (slides.length === 0) return;

            // Reset state
            slideIndex = 0;
            if (slideTimer) clearTimeout(slideTimer);

            showSlides();
        }

        function showSlides() {
            const slides = document.querySelectorAll('.slide');
            if (slides.length === 0) return;

            slides.forEach(s => s.classList.remove('active'));
            slideIndex++;
            if (slideIndex > slides.length) slideIndex = 1;
            slides[slideIndex - 1].classList.add('active');

            clearTimeout(slideTimer);
            slideTimer = setTimeout(showSlides, 5000);
        }

        function changeSlide(n) {
            const slides = document.querySelectorAll('.slide');
            if (slides.length === 0) return;

            slideIndex += n;
            if (slideIndex > slides.length) slideIndex = 1;
            if (slideIndex < 1) slideIndex = slides.length;
            slides.forEach(s => s.classList.remove('active'));
            slides[slideIndex - 1].classList.add('active');

            // Reset timer on manual change
            clearTimeout(slideTimer);
            slideTimer = setTimeout(showSlides, 5000);
        }

        // Modal
        const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));

        function openBookingModal(dest) {
            if (dest) {
                document.getElementById('toLoc').value = dest;
                // Update context banner
                const bannerText = document.getElementById('displayDestination');
                if (bannerText) bannerText.innerText = dest;

                // Keep title generic or minimal as we have the banner now
                // document.getElementById('bookingTitle').textContent = `Book Your Trip`; 
            } else {
                const bannerText = document.getElementById('displayDestination');
                if (bannerText) bannerText.innerText = "General Inquiry";
            }

            // Auto-fill
            if (window.Clerk && Clerk.user) {
                document.getElementById('name').value = Clerk.user.fullName || '';
                document.getElementById('email').value = Clerk.user.primaryEmailAddress.emailAddress || '';
                fetch(`/api/user/${Clerk.user.id}`)
                    .then(res => res.json())
                    .then(user => {
                        if (user && user.clerkId) {
                            if (user.phone) document.getElementById('phone').value = user.phone;
                            if (user.location) document.getElementById('address').value = user.location;
                        }
                    }).catch(e => console.log(e));
            }

            bookingModal.show();
        }

        async function handleBooking(e) {
            e.preventDefault();
            const bookingData = {
                clerkId: window.Clerk?.user?.id,
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                address: document.getElementById('address').value,
                serviceType: 'Travels',
                serviceName: document.getElementById('toLoc').value, // Using destination as service name context
                date: document.getElementById('date').value,

                // Schema Mappings
                pickupLocation: document.getElementById('fromLoc').value,
                dropDestination: document.getElementById('toLoc').value,
                passengerCount: document.getElementById('guests').value,
                notes: `Vehicle: ${document.getElementById('vehicle').value}`, // Map vehicle info to notes
                status: 'Pending'
            };

            try {
                const res = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });

                const result = await res.json();

                if (result.success) {
                    bookingModal.hide();
                    new bootstrap.Modal(document.getElementById('successModal')).show();
                    e.target.reset();
                } else {
                    alert('Request failed: ' + result.error);
                }
            } catch (err) {
                console.error(err);
                alert('An error occurred.');
            }
        }

        // Clerk Init
        window.addEventListener('load', async function () {
            await loadDynamicContent();

            if (window.Clerk) {
                await window.Clerk.load({
                    appearance: {
                        baseTheme: 'dark',
                        variables: {
                            colorPrimary: '#fcdc3b',
                            colorBackground: '#0f0f0f',
                            colorText: 'white',
                            borderRadius: '12px',
                            fontFamily: "'Outfit', sans-serif"
                        }
                    }
                });

                if (Clerk.user) {
                    Clerk.mountUserButton(document.getElementById('user-button'));
                } else {
                    const userButton = document.getElementById('user-button');
                    userButton.innerHTML = '<button class="btn-primary-glow" onclick="Clerk.openSignIn()">Sign In</button>';
                }
            }
        });
    </script>
</body>

</html>