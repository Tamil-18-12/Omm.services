<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Admin - Allocate & Publish Slots</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <style>
        body {
            background: linear-gradient(113deg, #501F56, #19021C);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #f1f1f1;
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 32px;
            background: linear-gradient(135deg, #501F56, #19021C);
            border-bottom: 1px solid rgba(252, 220, 59, 0.25);
            position: sticky;
            top: 0;
            z-index: 99;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .logo img {
            height: 54px;
            width: 54px;
            border-radius: 12px;
            object-fit: cover;
        }

        nav ul {
            list-style: none;
            display: flex;
            gap: 28px;
            margin: 0;
            padding: 0;
            font-weight: 700;
        }

        nav ul li {
            cursor: pointer;
            padding: 8px 16px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            border-radius: 22px;
            color: #ddd;
            transition: all 0.3s ease;
        }

        nav ul li:hover {
            background: #fcdc3b;
            color: #3a1d59;
            box-shadow: 0 0 12px #fcdc3b;
        }

        .booking-container {
            max-width: 550px;
            margin: 60px auto;
            padding: 35px;
            background: #fff;
            color: #3a1d59;
            border-radius: 22px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .booking-container h2 {
            font-weight: 800;
            margin-bottom: 25px;
            text-align: center;
            color: #501F56;
        }

        .event-info {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .event-info p {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .event-info strong {
            color: #19021C;
        }

        .locked-info h2 {
            color: #e74c3c;
        }

        .form-group {
            margin-top: 20px;
        }

        .form-group label {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .form-group input {
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #ddd;
            width: 100%;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .allocation-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8dff5;
            border-radius: 8px;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            color: #3a1d59;
        }

        .allocation-summary.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .publish-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 1px;
            background: #e74c3c;
            color: #fff;
            border: none;
            border-radius: 12px;
            margin-top: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .publish-btn:hover {
            background: #c0392b;
            box-shadow: 0 6px 20px rgba(192, 57, 43, 0.5);
        }
    </style>
</head>

<body>
    <nav>
        <div class="logo"><img src="logo.png" alt="Logo"></div>
        <ul>
            <li onclick="navigateTo('index.html')">Home</li>
            <li onclick="navigateTo('about.html')">About</li>
            <li onclick="navigateTo('contact.html')">Contact</li>
            <li onclick="navigateTo('review.html')">Review</li>
        </ul>
    </nav>

    <div class="booking-container" id="bookingContainer">
    </div>

    <script>
        let allEvents = [];
        let eventIndex = null;
        let currentEvent = null;
        let remainingCapacity = 0;

        window.onload = function () {
            const container = document.getElementById('bookingContainer');
            const params = new URLSearchParams(window.location.search);
            eventIndex = params.get('event');
            allEvents = JSON.parse(localStorage.getItem('catering_events') || '[]');

            if (eventIndex === null || !allEvents[eventIndex]) {
                container.innerHTML = '<h2>Error</h2><p>Event not found.</p>';
                return;
            }

            currentEvent = allEvents[eventIndex];

            // Initialize allocated slots if they don't exist
            currentEvent.adminSlotsAllocated = currentEvent.adminSlotsAllocated || 0;
            currentEvent.publicSlotsAllocated = currentEvent.publicSlotsAllocated || 0;

            const totalAllocated = currentEvent.adminSlotsAllocated + currentEvent.publicSlotsAllocated;
            remainingCapacity = currentEvent.members - totalAllocated;

            if (remainingCapacity <= 0) {
                // RENDER LOCKED VIEW
                container.innerHTML = `
                    <div class="locked-info">
                        <h2>ðŸ”’ Event Fully Booked & Locked</h2>
                        <p>All slots for this event have been allocated.</p>
                        <div class="event-info">
                            <p><strong>Location:</strong> ${currentEvent.location}</p>
                            <p><strong>Total Capacity:</strong> ${currentEvent.members}</p>
                            <p><strong>Total Admin Bookings:</strong> ${currentEvent.adminSlotsAllocated}</p>
                            <p><strong>Total Slots Published:</strong> ${currentEvent.publicSlotsAllocated}</p>
                        </div>
                    </div>
                `;
            } else {
                // RENDER ALLOCATION FORM
                container.innerHTML = `
                    <h2>Allocate & Publish More Slots</h2>
                    <div class="event-info">
                        <p><strong>Location:</strong> ${currentEvent.location}</p>
                        <p><strong>Total Capacity:</strong> ${currentEvent.members}</p>
                        <p><strong>Already Allocated:</strong> ${totalAllocated}</p>
                        <p><strong><font color="green">Remaining Slots:</font> ${remainingCapacity}</strong></p>
                    </div>
                    <div class="form-group">
                        <label for="adminSlots">Additional Slots to Book Internally:</label>
                        <input type="number" id="adminSlots" min="0" value="0" oninput="updateAllocation()" />
                    </div>
                    <div class="form-group">
                        <label for="publicSlots">Additional Slots to Publish:</label>
                        <input type="number" id="publicSlots" min="0" placeholder="e.g., ${remainingCapacity}" oninput="updateAllocation()" />
                    </div>
                    <div id="allocationSummary" class="allocation-summary">
                        Allocating: 0 / ${remainingCapacity} Remaining
                    </div>
                    <button class="publish-btn" onclick="finalizeAndPublish()">Allocate & Publish These Slots</button>
                `;
            }
        };

        function updateAllocation() {
            const adminSlots = parseInt(document.getElementById('adminSlots').value) || 0;
            const publicSlots = parseInt(document.getElementById('publicSlots').value) || 0;
            const totalToAllocate = adminSlots + publicSlots;

            const summaryDiv = document.getElementById('allocationSummary');
            summaryDiv.textContent = `Allocating: ${totalToAllocate} / ${remainingCapacity} Remaining`;

            if (totalToAllocate > remainingCapacity) {
                summaryDiv.classList.add('error');
            } else {
                summaryDiv.classList.remove('error');
            }
        }

        function finalizeAndPublish() {
            const additionalAdminSlots = parseInt(document.getElementById('adminSlots').value) || 0;
            const additionalPublicSlots = parseInt(document.getElementById('publicSlots').value) || 0;
            const totalToAllocate = additionalAdminSlots + additionalPublicSlots;

            // --- Validation ---
            if (totalToAllocate <= 0) {
                alert('Please enter a number of slots to allocate.');
                return;
            }
            if (totalToAllocate > remainingCapacity) {
                alert('Error: The number of slots you are trying to allocate exceeds the remaining capacity.');
                return;
            }

            // --- Update the main event object ---
            currentEvent.adminSlotsAllocated += additionalAdminSlots;
            currentEvent.publicSlotsAllocated += additionalPublicSlots;
            allEvents[eventIndex] = currentEvent;
            localStorage.setItem('catering_events', JSON.stringify(allEvents));

            // --- Create a transaction log entry for the database ---
            const logEntry = {
                eventIndex: eventIndex,
                eventDetails: { location: currentEvent.location, members: currentEvent.members },
                adminSlots: additionalAdminSlots, // Log only this transaction's slots
                publicSlots: additionalPublicSlots,
                publishTimestamp: new Date()
            };
            const database = JSON.parse(localStorage.getItem('admin_booking_database') || '[]');
            database.push(logEntry);
            localStorage.setItem('admin_booking_database', JSON.stringify(database));

            // --- Update the public-facing event object ---
            const publishedEvent = {
                ...currentEvent, // Copy details
                availableSlots: currentEvent.publicSlotsAllocated // Show TOTAL public slots
            };
            localStorage.setItem('published_event', JSON.stringify(publishedEvent));

            alert(`${totalToAllocate} more slots have been allocated successfully!`);

            // Reload the page to show the updated state (or the locked view if now full)
            window.location.reload();
        }
    </script>
</body>

</html>