<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking System Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #050505;
            color: #ffffff;
            font-family: 'Outfit', sans-serif;
            min-height: 100vh;
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #050505 75%);
        }

        .container {
            max-width: 1200px;
            margin-top: 50px;
        }

        h1 {
            font-weight: 700;
            margin-bottom: 2rem;
            color: #D4AF37;
            text-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        /* Test Card */
        .test-card {
            background: rgba(20, 20, 20, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(12px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .test-card h3 {
            color: #D4AF37;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .form-control {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 8px;
        }

        .form-control:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: #D4AF37;
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1);
            color: white;
        }

        .btn-test {
            background: #D4AF37;
            color: #000;
            font-weight: 600;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-test:hover {
            background: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        .result-box {
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            color: #0f0;
            min-height: 50px;
            white-space: pre-wrap;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-badge.success {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .status-badge.error {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="text-center mb-4" style="color: #D4AF37;">üîß Booking System Diagnostic Tool</h1>

        <div class="test-card">
            <h3>üìä System Status</h3>
            <p>Server: <span id="server-status" class="status-badge status-error">Checking...</span></p>
            <p>MongoDB: <span id="db-status" class="status-badge status-error">Checking...</span></p>
            <p>Total Bookings: <span id="booking-count" style="color: #D4AF37; font-weight: bold;">-</span></p>
        </div>

        <div class="test-card">
            <h3>üß™ Quick Tests</h3>
            <button class="btn btn-test" onclick="testServerConnection()">Test Server</button>
            <button class="btn btn-test" onclick="fetchAllBookings()">Fetch All Bookings</button>
            <button class="btn btn-test" onclick="createTestBooking()">Create Test Booking</button>
            <button class="btn btn-test" onclick="clearLogs()">Clear Logs</button>
        </div>

        <div class="test-card">
            <h3>üìù Console Logs</h3>
            <div class="log-output" id="log-output">
                <div>System initialized. Ready for testing...</div>
            </div>
        </div>

        <div class="test-card">
            <h3>üì¶ Recent Bookings</h3>
            <div id="bookings-list" style="max-height: 300px; overflow-y: auto;">
                <p class="text-muted">Click "Fetch All Bookings" to load data...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#0ff',
                success: '#0f0',
                error: '#f00',
                warning: '#ff0'
            };
            output.innerHTML += `<div style="color: ${colors[type]};">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('log-output').innerHTML = '<div>Logs cleared.</div>';
        }

        async function testServerConnection() {
            log('Testing server connection...', 'info');
            try {
                const response = await fetch('/api/bookings');
                if (response.ok) {
                    log('‚úÖ Server is responding!', 'success');
                    document.getElementById('server-status').className = 'status-badge status-success';
                    document.getElementById('server-status').textContent = 'Online';
                    return true;
                } else {
                    throw new Error(`Server returned ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Server error: ${error.message}`, 'error');
                document.getElementById('server-status').className = 'status-badge status-error';
                document.getElementById('server-status').textContent = 'Offline';
                return false;
            }
        }

        async function fetchAllBookings() {
            log('Fetching all bookings from MongoDB...', 'info');
            try {
                const response = await fetch('/api/bookings');
                const bookings = await response.json();

                log(`‚úÖ Found ${bookings.length} bookings in database`, 'success');
                document.getElementById('booking-count').textContent = bookings.length;
                document.getElementById('db-status').className = 'status-badge status-success';
                document.getElementById('db-status').textContent = 'Connected';

                // Display bookings
                const list = document.getElementById('bookings-list');
                if (bookings.length === 0) {
                    list.innerHTML = '<p class="text-warning">‚ö†Ô∏è No bookings found in database. Try creating a test booking.</p>';
                } else {
                    list.innerHTML = bookings.map((b, i) => `
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #D4AF37;">
                            <strong style="color: #D4AF37;">#${i + 1} - ${b.serviceType}</strong><br>
                            <small>Service: ${b.serviceName || 'N/A'}</small><br>
                            <small>Name: ${b.name || 'N/A'}</small><br>
                            <small>Date: ${b.date || 'N/A'}</small><br>
                            <small>Phone: ${b.phone || 'N/A'}</small><br>
                            <small>Email: ${b.email || 'N/A'}</small><br>
                            <small style="opacity: 0.6;">ID: ${b._id}</small>
                        </div>
                    `).join('');
                    log(`üìã Displayed ${bookings.length} bookings`, 'info');
                }
            } catch (error) {
                log(`‚ùå Failed to fetch bookings: ${error.message}`, 'error');
                document.getElementById('db-status').className = 'status-badge status-error';
                document.getElementById('db-status').textContent = 'Error';
            }
        }

        async function createTestBooking() {
            log('Creating test booking...', 'info');
            const testData = {
                serviceType: 'Test Service',
                serviceName: 'Diagnostic Test Booking',
                name: 'Test User',
                age: 25,
                phone: '1234567890',
                email: 'test@example.com',
                address: 'Test Address',
                date: new Date().toISOString().split('T')[0],
                guests: 10
            };

            log(`üì¶ Sending: ${JSON.stringify(testData, null, 2)}`, 'info');

            try {
                const response = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });

                const result = await response.json();

                if (response.ok) {
                    log(`‚úÖ Test booking created successfully!`, 'success');
                    log(`üìù Response: ${JSON.stringify(result, null, 2)}`, 'success');
                    setTimeout(() => fetchAllBookings(), 500);
                } else {
                    throw new Error(result.message || 'Server rejected the booking');
                }
            } catch (error) {
                log(`‚ùå Failed to create booking: ${error.message}`, 'error');
            }
        }

        // Auto-run on page load
        window.addEventListener('load', async () => {
            log('üöÄ Starting diagnostic tests...', 'info');
            const serverOk = await testServerConnection();
            if (serverOk) {
                await fetchAllBookings();
            }
        });
    </script>
</body>

</html>